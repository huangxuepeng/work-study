## 项目概述
1. 与15s软件商店同步
2. 与软件安装部署同步
3. 实现对软件段的管理
4. 对软件段的卸载/安装
## 总体设计
![总体图](./%E8%AE%BE%E8%AE%A1%E6%80%BB.png)
### 软件段创建
1. 软件段创建前由前端调用接口判断该段的存在状态
    - 如果软件段已经存在则直接提示用户需要上传的段已存在, 不需要再次上传
    - 如果软件段不存在则进入步骤2
2. 前端调用上传段接口，传入段文件 
    - 后端通过软件段的后缀判断压缩方式 
        - 如果软件段的后缀是mpk, 将此软件段同步到15s; 
        - 如果软件段的后缀是zip, 将此软件段同步到软件安装部署.
    - 服务端解析段文件并且获取元信息, 判断段是否已经存在，
        - 如果软件段已经存在，则直接返回段已存在, 不需要进行创建；
        - 如果软件段不存在，保存段文件到共享存储，并创建段记录（包含段的元信息）写入etcd
3. 控制器监听到etcd段新增事件
    - 控制器通过`SDP client`调用rpc接口在`SDP`中同步新增段，更新同步创建的结果（状态、时间、失败原因等）
        - 如果更新同步创建失败，则间隔一段时间后进行重试并累加重试次数，直到创建成功或者重试次数超过阈值，重试次数和间隔时间可配置；
        - 如果更新同步创建成功，更新etcd段记录中的`remoteExtra`字段信息，包括段在`SDP`中的id等   

![软件段创建](./%E8%BD%AF%E4%BB%B6%E6%AE%B5%E5%88%9B%E5%BB%BA.png)
![时序图](./%E8%BD%AF%E4%BB%B6%E6%AE%B5%E4%B8%8A%E4%BC%A0%E6%97%B6%E5%BA%8F%E5%9B%BE.png)
### 删除段
1. 用户请求删除段, 调用服务端删除段接口, 传入软件段id
2. 服务端通过id获取软件段信息
    - 判断软件段是否存在, 
        - 若软件段不存在直接返回错误信息 
        - 若软件段存在则继续执行
    - 判断段记录的`deleteStatus`，如果其为`Processing`，则直接返回前端删除成功（已经在删除中，无需重复提交）
    - 判断段是否已安装或者正在安装
        - 如果软件段的安装状态是已安装或者正在安装直接返回段已安装，不可删除；
            - 如果软件段的安装状态是正在安装中，将段记录的`deleteStatus`字段置为`Processing`，更新etcd中该记录
3. 控制器监听到etcd段记录更新事件通过更新前后的段记录`deleteStatus`字段判断是否为段删除
    - 如果etcd中软件段的段记录已删除则执行步骤4
    - 如果etcd中软件段的段记录未被删除则不做处理
4. 控制器通过`SDP client`调用rpc接口传入段在`SDP`中的id，在`SDP`中同步删除段
    - 如果段删除成功，直接删除etcd中该条段记录，并且删除段安装记录和段安装日志中的相应记录以及共享存储中的段文件；
    - 如果段删除失败, 将etcd中该条段记录的`deleteStatus`字段置为`failed`，并记录删除失败原因   

![删除段](./%E5%88%A0%E9%99%A4%E6%AE%B5.png)
### 获取软件段列表
用户传入分页信息, 筛选参数，将软件段列表返回前端
### 获取某个软件段的所有版本
1. 用户请求获取指定软件段的所有版本, 用户传入软件段id
2. 通过id查询etcd中是否存在该软件段, 
    - 不存在该软件段, 退出逻辑并且返回错误; 
    - 存在, 通过软件段的前缀从etcd中获取该软件段的所有版本
3. 将获取到的软件段所有版本信息返回前端展示  

![获取某个软件段的所有版本](./%E8%8E%B7%E5%8F%96%E6%9F%90%E4%B8%AA%E8%BD%AF%E4%BB%B6%E6%AE%B5%E7%9A%84%E6%89%80%E6%9C%89%E7%89%88%E6%9C%AC.png)
### 更新段绑定的席位列表信息
1. 用户请求获取软件段绑定的席位信息, 传入软件段id
2. 通过id查询软件段是否存在与etcd中, 
    - 如果该软件段不存在, 退出逻辑并且返回错误; 
    - 如果该软件段存在, 根据软件段前缀更新它的所有版本的席位列表信息
3. 将该软件段的的席位信息返回前端展示.  

![更新段绑定的席位列表信息](./%E6%9B%B4%E6%96%B0%E6%AE%B5%E7%BB%91%E5%AE%9A%E7%9A%84%E5%B8%AD%E4%BD%8D%E5%88%97%E8%A1%A8%E4%BF%A1%E6%81%AF.png)
### 段安装/卸载
1. 用户请求把段安装到席位列表中，调用服务端安装段接口，传入段id和席位列表
2. 服务端通过段id获取到段记录
   - 判断该软件段是否同步成功，
     - 如果软件段未同步成功直接返回段不可安装;
     - 如果软件段安装成功, 则新建段安装记录（`SegInstallRecord`）
   - 对比段已安装席位和传入的席位列表，
     - 对于新席位，执行安装（写入到`installSeatList`中）
     - 移除的席位，执行卸载（写入到`uninstallSeatList`中）
     - 已安装席位不做处理，整理好的安装记录（`SegInstallRecord`）写入etcd中
3. 控制器监听到段安装记录新增事件
    - 控制器根据安装记录中的`installSeatList`和`uninstallSeatList`，整理出需要安装的节点ip列表以及需要卸载的节点ip列表
    - 控制器通过`SDP client`调用rpc接口批量安装/卸载（传入设备ip列表以及段在`SDP`中的id），获取到批量安装/卸载的任务id
    - 控制器启动定时器调用rpc接口传入任务id轮询安装/卸载的进度，计算安装`percent`，将进度、时间、状态等更新到段安装日志中
4.  软件段安装/卸载成功后，更新段记录的席位信息.   

![段安装/卸载](./%E6%AE%B5%E5%AE%89%E8%A3%85.png)
### 数据同步实现
通过`SDP client`拉取`SDP`中的段列表，与etcd中存储的段列表进行比对
1. 对于新增的段，通过`SDP client`从`SDP`中下载对应的段文件保存到共享存储，并解析段文件获取段基本信息构建段记录，向etcd中插入段记录（设置其`isLocal`字段为`false`，代表段非本地上传）
2. 对于删除的段，通过其在`SDP`中的id，找出etcd段记录中`remoteExtra.uid`字段与之匹配的记录，删除该条记录 ，同时删除共享存储中的段文件以及etcd中该段的安装记录（包括段安装日志）
